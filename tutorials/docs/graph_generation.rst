.. _graph_generation: 

Graph Generation
****************

- `Overview`_
- `Requirements`_
- `Tutorial Steps`_

Overview
========
This tutorial walker the user though generating a graph to be consumed by the nav2_route.

Requirements
============
Follow https://www.qgis.org/en/site/forusers/download.html to install QGIS.

Tutorial Steps
==============

1- Open QGIS and create a new project and set the project coordinate reference system.

|

 .. image:: images/graph_generation/coordinate_reference_system.png
    :height: 300px
    :width: 400px
    :align: center

|

2- If you don't need to adjust your raster image to the map frame simply click
Layer -> Add Layer -> Add Raster Layer. Select your raster image add the data source.

3- If you need to adjust your raster image to tha map frame open the georeferencer tool
by clicking Raster -> Georefencer. Setup up the transformation setting as seen in the image below.

|

 .. image:: images/graph_generation/transformation_settings.png
    :height: 500px
    :width: 300px
    :align: center

|

Select the raster image you wish to georeference and select at least three points. Apply the
transform.

|

 .. image:: images/graph_generation/georeferencer.png
    :height: 400px
    :width: 600px
    :align: center

|

Drag and drop the raster file output into the layers window.

4- Now that we have the raster layer in the correct coordinate system we can start placing nodes.

|

 .. image:: images/graph_generation/raster_layer.png
    :height: 400px
    :width: 600px
    :align: center

|


Select Layer -> Create Layer -> New ShapeFile Layer. Make sure the name of the layer is nodes,
the type is point, and the correct coordinate system is set.

|

 .. image:: images/graph_generation/node_layer.png
    :height: 300px
    :width: 400px
    :align: center

|

Click on the node layer and use the tool bar to start adding nodes.

|

 .. image:: images/graph_generation/nodes.png
    :height: 600px
    :width: 400px
    :align: center

|


5- Select Layer -> Create Layer -> New ShapeFile Layer. Make sure the name of the layer is edges,
the type is LineString and the correct coordinate system is set.

|

 .. image:: images/graph_generation/edge_layer.png
    :height: 300px
    :width: 400px
    :align: center

|

Click on the edge layer and use the tool bar to start adding edges. Use the magnet tool to snap
the start and end points of the edge to the nodes.

|

 .. image:: images/graph_generation/edges.png
    :height: 600px
    :width: 400px
    :align: center

|

6- Select the node layer and then click on the field calculator tool. Check the update existing
field box and select id. Add the row number to the expression field and click ok.

|

 .. image:: images/graph_generation/field_calculator.png
    :height: 300px
    :width: 400px
    :align: center

|

This will generate ids for each node. To verify that the ids have been generate right click on
the node layer and open the attribute table.

Follow this same process for the edges but be sure to increase the row number by the number of
nodes.


7- Select Database -> DB manager -> expand virtual layers -> expand project layers and open up
the SQL window. In the sql window load in node connector script. This script associates the
start and end node ids with an edge. Execute the script and load in the new layer.

|

 .. image:: images/graph_generation/sql_script.png
    :height: 300px
    :width: 400px
    :align: center

|

8- Right click on the nodes layer -> Export -> Save Feature As. Set the format to geojson and
verify the coordinate reference system is correct. Click OK.

|

 .. image:: images/graph_generation/export_to_geojson.png
    :height: 300px
    :width: 400px
    :align: center

|

Follow the same process for the edge layer generated by the sql script.

9- Create a new geojson file. Copy the nodes geojson file into the new file. Insert the features
from the edges geojson file into the features tag in the new geojson file.

|

 .. image:: images/graph_generation/geojson_graph.png
    :height: 300px
    :width: 400px
    :align: center

|

Happy Routing!

